version: '3.8'

services:
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    ports:
      - "8080:80"
    depends_on:
      - websocket
      - lainllm
      - tts
      - animation
    networks:
      - lain-network

  redis:
    image: redis:7-alpine
    command:
      - redis-server
      - --appendonly
      - "yes"
      - --maxmemory
      - 512mb
      - --maxmemory-policy
      - allkeys-lru
    networks:
      - lain-network
    volumes:
      - redis-data:/data

  # Qdrant removed - now using ICP canister (ai_api_backend) for embeddings
  # The canister ID is: zbpu3-baaaa-aaaad-qhpha-cai
  # It contains personality embeddings and memex.wiki knowledge

  lainllm:
    build:
      context: ./ai-agent
      dockerfile: Dockerfile
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ICP_CANISTER_ID=zbpu3-baaaa-aaaad-qhpha-cai
      - ICP_HOST=https://ic0.app
      - MODEL_PATH=/models/lain-model.gguf
      - N_THREADS=8
      - N_CTX=4096
      - N_BATCH=512
      - TEMPERATURE=0.8
      - MAX_TOKENS=150
    depends_on:
      - redis
    networks:
      - lain-network
    volumes:
      - model-cache:/models

  websocket:
    build:
      context: ./websocket
      dockerfile: Dockerfile
    environment:
      - LAINLLM_URL=http://lainllm:8001
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - lainllm
      - redis
    networks:
      - lain-network

  tts:
    build:
      context: ./tts
      dockerfile: Dockerfile
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    networks:
      - lain-network

  animation:
    build:
      context: ./animation
      dockerfile: Dockerfile
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    networks:
      - lain-network

networks:
  lain-network:
    driver: bridge

volumes:
  redis-data:
  model-cache:
