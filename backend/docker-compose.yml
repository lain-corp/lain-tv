version: '3.8'

services:
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    ports:
      - "8080:80"
    depends_on:
      - websocket
      - lainllm
      - tts
      - animation
    networks:
      - lain-network

  redis:
    image: redis:7-alpine
    command:
      - redis-server
      - --appendonly
      - "yes"
      - --maxmemory
      - 512mb
      - --maxmemory-policy
      - allkeys-lru
    networks:
      - lain-network
    volumes:
      - redis-data:/data

  qdrant:
    image: qdrant/qdrant:latest
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__MAX_REQUEST_SIZE_MB=32
    networks:
      - lain-network
    volumes:
      - qdrant-data:/qdrant/storage

  lainllm:
    build:
      context: ./ai-agent
      dockerfile: Dockerfile
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - MODEL_PATH=/models/lain-model.gguf
      - N_THREADS=8
      - N_CTX=4096
      - N_BATCH=512
      - TEMPERATURE=0.8
      - MAX_TOKENS=150
    depends_on:
      - redis
      - qdrant
    networks:
      - lain-network
    volumes:
      - model-cache:/models

  websocket:
    build:
      context: ./websocket
      dockerfile: Dockerfile
    environment:
      - LAINLLM_URL=http://lainllm:8001
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - lainllm
      - redis
    networks:
      - lain-network

  tts:
    build:
      context: ./tts
      dockerfile: Dockerfile
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    networks:
      - lain-network

  animation:
    build:
      context: ./animation
      dockerfile: Dockerfile
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    networks:
      - lain-network

networks:
  lain-network:
    driver: bridge

volumes:
  redis-data:
  qdrant-data:
  model-cache:
